---
title: "Cannabis referendum report"
author: "Thao Nguyen"
date: "2024-08-06"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
#

# Load library
library(tidyverse)
library(dplyr)
library(kableExtra)
library(mice)
library(broom)
```

# Summary
This report works on the Cannabis referendum data in 2020 for a decision whether it is worth pursuing a citizen initiated referendum in the next election cycle. To investigate if the support is there, we need to address the following research questions.
1. What proportion of people in the sample supported legalisation ?
2. Who in the sample supported legalisation ?


# Data imputation

In this first stage, we explore the dataset by checking the first few rows and find the structure as well as the statistical summary of each variable.

```{r echo = FALSE}
# Load data into the environment
df_referendum <- read.csv('referendum_survey_lab_version.csv', header = TRUE)

# Explore the data
head(df_referendum) # The first rows of the dataset
str(df_referendum) # The dataset structure
summary(df_referendum) # The statistical summary of each variable
```

We can find a considerable amount of missingness in the data. It is believed this is because some people, particularly younger people, were reluctant to give their voting preference.

Table on missingness of each variable in the dataset can be found as the following.

```{r}
# Replace blank values with NA
df_referendum <- df_referendum %>% 
  mutate(across(everything(), ~ replace(., . == "", NA)))

# Check for missingness in each variable
missingness <- df_referendum %>% 
  summarise(across(everything(), ~ sum(is.na(.))))

# Display the summary table of missingness
missingness %>%
    kable(col.names = c("Age", "Gender", "Referendum"), caption = "Table of missingess of each variable", align = 'cc') %>%
    kableExtra::kable_styling(full_width = F)
```

# Visualisation on demographics

```{r}

# Visualize to show the distribution of age across genders
ggplot(df_referendum, aes(x = factor(age))) +
  geom_bar() +
  facet_wrap(~ gender
             , ncol=1) +
  labs(title = "Distribution of Age Across Genders",
       x = "Age",
       y = "Count") +
  theme_minimal()
```


# Inline reporting of proportions

The proportion of 'yes' voters in the referendum is `r round(sum(df_referendum$referendum == 1, na.rm = TRUE) / sum(!is.na(df_referendum$referendum)), 3)`%.

# Tables of each logistic regression
```{r}
# Load data 
referendum_raw <- df_referendum

# Conduct a logistic regression model and assign result to ref_model
ref_model <- glm(referendum ~ age + gender, data = referendum_raw, family = binomial)

# Extract summary of the model
model_summary <- summary(ref_model)

# Extract coefficients table
coef_table <- as.data.frame(model_summary$coefficients)

# Rename columns
colnames(coef_table) <- c("Estimate", "Std. Error", "Z value", "P value")

# Add row names as a column
coef_table$Term <- rownames(coef_table)
coef_table <- coef_table[, c("Term", "Estimate", "Std. Error", "Z value", "P value")]

# Create the table with kableExtra
coef_table %>%
  kable(col.names = c("Term", "Estimate", "Std. Error", "Z value", "P value"),
        caption = "Logistic Regression Results for Referendum Voting") %>%
  kable_styling(full_width = F)

```
Imputed cases using the mice package.
```{r}
# Run multiple imputation
referendum_imputed <- mice(referendum_raw, m = 5, seed = 500)

# Calculate the proportion of yes voters
# Use 'long' format to handle all imputed datasets
imputed_data <- complete(referendum_imputed, "long")
mean_proportion <- round(mean(imputed_data$referendum == 1, na.rm = TRUE), 2)

# Fit the logistic regression model on each of the imputed datasets,
# pool them, and show summary stats
fit <- with(referendum_imputed, glm(referendum ~ age + gender, family = binomial))
pooled <- pool(fit)
summary_pooled <- summary(pooled)

# Create a clean table using kableExtra
table <- tidy(pooled) %>%
  kable("html", caption = "Logistic Regression Results on Imputed Data") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

# Print the table
print(table)

# Output the mean proportion of yes voters
mean_proportion
```



# Conclusion



